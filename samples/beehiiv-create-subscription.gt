--------------------------------------------------------------------------------
-- ðŸ“¡ SERVICES:
--------------------------------------------------------------------------------
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : Beehiiv                                                     â”‚
-- â”‚ URL         : https://api.beehiiv.com/v2                                  â”‚
-- â”‚ HEADERS     :                                                             â”‚
-- â”‚     - KEY   : Authorization                                               â”‚
-- â”‚       VALUE : Bearer [BEEHIIV_API_KEY]                                    â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : ct-programs-vercel-app                                      â”‚
-- â”‚ URL         : https://ct-programs.vercel.app/api                          â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
--------------------------------------------------------------------------------
-- ðŸ‘‰ INPUTS:
--------------------------------------------------------------------------------
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : beehiiv_publication_id                                      â”‚
-- â”‚ REQUIRED    : yes ðŸš¨                                                      â”‚
-- â”‚ TYPE        : string                                                      â”‚
-- â”‚ DESCRIPTION : the ID of the publication for which to create the new       â”‚
-- â”‚               subscription                                                â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : email_address                                               â”‚
-- â”‚ REQUIRED    : yes ðŸš¨                                                      â”‚
-- â”‚ TYPE        : string                                                      â”‚
-- â”‚ DESCRIPTION : the email address to use to create the new subscription     â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : payload                                                     â”‚
-- â”‚ REQUIRED    : no                                                          â”‚
-- â”‚ TYPE        : association                                                 â”‚
-- â”‚ DEFAULT     : {}                                                          â”‚
-- â”‚ DESCRIPTION : the request body to be sent to Beehiiv; can include         â”‚
-- â”‚               options like custom field values, tags, etc.; see the       â”‚
-- â”‚               Beehiiv API documentation linked below for more info about  â”‚
-- â”‚               the properties that can be included                         â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : should_standardize_email_address                            â”‚
-- â”‚ REQUIRED    : no                                                          â”‚
-- â”‚ TYPE        : binary (0 or 1)                                             â”‚
-- â”‚ DEFAULT     : 1                                                           â”‚
-- â”‚ DESCRIPTION : whether or not to apply standard formatting rules to the    â”‚
-- â”‚               email address (e.g., removing whitespace, converting to     â”‚
-- â”‚               lower-case, etc.)                                           â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
--------------------------------------------------------------------------------
-- ðŸ‘ˆ OUTPUTS:
--------------------------------------------------------------------------------
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : beehiiv_subscription                                        â”‚
-- â”‚ TYPE        : association                                                 â”‚
-- â”‚ DESCRIPTION : the new or updated Beehiiv subscription                     â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ NAME        : service_responses                                           â”‚
-- â”‚ TYPE        : collection of associations                                  â”‚
-- â”‚ DESCRIPTION : responses from service calls                                â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
--------------------------------------------------------------------------------
-- ðŸ“œ NOTES:
--------------------------------------------------------------------------------
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ Beehiiv's subscription creation API endpoint does not automatically       â”‚
-- â”‚ reactivate inactive subscriptions. This behavior can be overridden and    â”‚
-- â”‚ inactive accounts can be reactivated, however, by including a             â”‚
-- â”‚ "reactivate_existing" property with a `true` value on the API request     â”‚
-- â”‚ body. For the sake of simplicity and consistency, this program *does*     â”‚
-- â”‚ include that property (with a `true` value) by default â€” though it will   â”‚
-- â”‚ also respect the value of the property if it already exists on the        â”‚
-- â”‚ `payload` association. In other words, to *avoid* reactivating an         â”‚
-- â”‚ inactive subscription, set the "reactivate_existing" property on the      â”‚
-- â”‚ `payload` association to a false-ish value (0, "no", or `false`) before   â”‚
-- â”‚ calling this program.                                                     â”‚
-- â”‚                                                                           â”‚
-- â”‚ Please refer to the Beehiiv API documentation for this endpoint for more  â”‚
-- â”‚ information:                                                              â”‚
-- â”‚ https://developers.beehiiv.com/api-reference/subscriptions/create         â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
--------------------------------------------------------------------------------

>> true = "true".decode("JSON")
>> false = "false".decode("JSON")
>> error_title = "@jrc03c/beehiiv/create-subscription"

*if: not error_is_fatal
	>> error_is_fatal = "no"

*if: not beehiiv_publication_id
	>> error_message = "You must define a variable called <code>beehiiv_publication_id</code> that has a string value representing the ID of the Beehiiv publication for which a new subscription will be created!"
	*program: @jrc03c/show-error
	*goto: a417726d1ac87675a43b9c2eead0b89b

*if: not (beehiiv_publication_id.type = "string")
	>> error_message = "You must define a variable called <code>beehiiv_publication_id</code> that has a string value representing the ID of the Beehiiv publication for which a new subscription will be created!"
	*program: @jrc03c/show-error
	*goto: a417726d1ac87675a43b9c2eead0b89b

>> x = 5

*if: x > 7
	Hey!

*if: not email_address
	>> error_message = "You must define a variable called <code>email_address</code> that has a string value representing the email address to use to create the new subscription!"
	*program: @jrc03c/show-error
	*goto: a417726d1ac87675a43b9c2eead0b89b

*if: not (email_address.type = "string")
	>> error_message = "You must define a variable called <code>email_address</code> that has a string value representing the email address to use to create the new subscription!"
	*program: @jrc03c/show-error
	*goto: a417726d1ac87675a43b9c2eead0b89b

*if: not service_responses
	>> service_responses = []

*if: not should_standardize_email_address
	>> should_standardize_email_address = 1

--------------------------------------------------------------------------------
-- Standardize the email address
--------------------------------------------------------------------------------

*if: should_standardize_email_address = 1
	*program: @jrc03c/email/standardize-email-address

	*if: service_response
		>> service_responses.add(service_response)

	*if: email_address_standardized
		>> email_address = email_address_standardized

	*if: not email_address_standardized
		*goto: a417726d1ac87675a43b9c2eead0b89b

--------------------------------------------------------------------------------
-- Create the new subscription (or update the existing subscription)
--------------------------------------------------------------------------------

-- NOTE: This API call performs an "upsert" (i.e., an update or an insert). In
-- other words, if a subscription already exists for the given email address,
-- then it is updated; otherwise, a new subscription is created. Therefore, it
-- is not necessary to check for the existence of a subscription before making
-- this call.

*if: not payload
	>> payload = {}

>> payload["email"] = email_address

*if: "reactivate_existing" in payload
	*if: payload["reactivate_existing"] = 0
		>> payload["reactivate_existing"] = false

	*if: payload["reactivate_existing"] = "no"
		>> payload["reactivate_existing"] = false

	*if: payload["reactivate_existing"] = 1
		>> payload["reactivate_existing"] = true

	*if: payload["reactivate_existing"] = "yes"
		>> payload["reactivate_existing"] = true

*if: not ("reactivate_existing" in payload)
	>> payload["reactivate_existing"] = true

>> service_response = {}
>> service_response["service"] = "Beehiiv"
>> service_response["method"] = "POST"
>> service_response["path"] = "/publications/{beehiiv_publication_id}/subscriptions"
>> service_response["payload"] = payload
>> temp = {}

*service: Beehiiv
	*method: POST
	*path: /publications/{beehiiv_publication_id}/subscriptions
	*send: payload
	*success
		>> beehiiv_subscription = it["data"]
		>> temp = it
	*error
		>> temp = it

*for: key in temp.keys
	>> service_response[key] = temp[key]

>> service_responses.add(service_response)

--------------------------------------------------------------------------------
-- Clean up
--------------------------------------------------------------------------------

*label: a417726d1ac87675a43b9c2eead0b89b

>> email_address_standardized = ""
>> error_is_fatal = ""
>> error_message = ""
>> error_title = ""
>> false = ""
>> key = ""
>> payload = ""
>> service_response = ""
>> should_standardize_email_address = ""
>> temp = ""
>> true = ""
